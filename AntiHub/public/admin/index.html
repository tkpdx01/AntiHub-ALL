<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AntiHub Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: #1a1a1a;
      border-bottom: 1px solid #2a2a2a;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
      color: #fff;
    }

    .logout-btn {
      background: transparent;
      border: 1px solid #444;
      color: #aaa;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .logout-btn:hover {
      background: #2a2a2a;
      color: #fff;
    }

    /* Main Content */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .stat-card {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      padding: 20px;
    }

    .stat-card .label {
      font-size: 13px;
      color: #888;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: 600;
      color: #fff;
    }

    .stat-card .value.skeleton {
      height: 34px;
      width: 60px;
      border-radius: 4px;
    }

    /* Section */
    .section {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .section-header {
      padding: 16px 20px;
      border-bottom: 1px solid #2a2a2a;
      font-size: 15px;
      font-weight: 600;
      color: #fff;
    }

    .section-body {
      padding: 20px;
    }

    /* Channel Grid */
    .channel-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .channel-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .channel-card {
      background: #222;
      border-radius: 8px;
      padding: 16px;
    }

    .channel-card .name {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 12px;
    }

    .channel-card .stat {
      font-size: 13px;
      color: #aaa;
      margin-bottom: 4px;
    }

    .channel-card .stat span {
      color: #4ade80;
    }

    .channel-card .stat.skeleton {
      height: 18px;
      width: 80px;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      text-align: left;
      padding: 12px 16px;
      color: #888;
      font-weight: 500;
      border-bottom: 1px solid #2a2a2a;
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid #222;
    }

    tr:hover {
      background: #1f1f1f;
    }

    .status-success {
      color: #4ade80;
    }

    .status-error {
      color: #f87171;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    /* Skeleton Animation */
    .skeleton {
      background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-row {
      display: flex;
      gap: 16px;
      padding: 12px 16px;
      border-bottom: 1px solid #222;
    }

    .skeleton-cell {
      height: 18px;
      border-radius: 4px;
    }

    .skeleton-cell.time { width: 70px; }
    .skeleton-cell.channel { width: 90px; }
    .skeleton-cell.model { width: 140px; }
    .skeleton-cell.cost { width: 50px; }
    .skeleton-cell.status { width: 30px; }

    /* Error State */
    .error-banner {
      background: #2d1f1f;
      border: 1px solid #5c2828;
      color: #f87171;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      display: none;
    }

    /* Refresh Button */
    .refresh-btn {
      background: #2563eb;
      border: none;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 12px;
    }

    .refresh-btn:hover {
      background: #1d4ed8;
    }

    .refresh-btn:disabled {
      background: #444;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>AntiHub Dashboard</h1>
    <div>
      <button class="refresh-btn" onclick="loadDashboard()" id="refreshBtn">刷新</button>
      <button class="logout-btn" onclick="logout()">退出登录</button>
    </div>
  </header>

  <main class="main">
    <div class="error-banner" id="errorBanner"></div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">总账号</div>
        <div class="value skeleton" id="totalAccounts"></div>
      </div>
      <div class="stat-card">
        <div class="label">活跃账号</div>
        <div class="value skeleton" id="activeAccounts"></div>
      </div>
      <div class="stat-card">
        <div class="label">24h 消耗 ($)</div>
        <div class="value skeleton" id="totalCost"></div>
      </div>
      <div class="stat-card">
        <div class="label">24h 调用</div>
        <div class="value skeleton" id="totalCalls"></div>
      </div>
    </div>

    <!-- Channel Overview -->
    <div class="section">
      <div class="section-header">渠道概览</div>
      <div class="section-body">
        <div class="channel-grid" id="channelGrid">
          <div class="channel-card">
            <div class="name">Antigravity</div>
            <div class="stat skeleton" id="antigravityStat1"></div>
            <div class="stat skeleton" id="antigravityStat2"></div>
          </div>
          <div class="channel-card">
            <div class="name">Kiro</div>
            <div class="stat skeleton" id="kiroStat1"></div>
            <div class="stat skeleton" id="kiroStat2"></div>
          </div>
          <div class="channel-card">
            <div class="name">Qwen</div>
            <div class="stat skeleton" id="qwenStat1"></div>
            <div class="stat skeleton" id="qwenStat2"></div>
          </div>
          <div class="channel-card">
            <div class="name">Codex</div>
            <div class="stat skeleton" id="codexStat1"></div>
            <div class="stat skeleton" id="codexStat2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Calls -->
    <div class="section">
      <div class="section-header">最近调用（最新 30 条）</div>
      <div class="section-body">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>时间</th>
                <th>渠道</th>
                <th>模型</th>
                <th>消耗</th>
                <th>状态</th>
              </tr>
            </thead>
            <tbody id="recentCalls">
              <!-- Skeleton rows -->
              <tr class="skeleton-row-wrapper">
                <td colspan="5">
                  <div class="skeleton-row">
                    <div class="skeleton skeleton-cell time"></div>
                    <div class="skeleton skeleton-cell channel"></div>
                    <div class="skeleton skeleton-cell model"></div>
                    <div class="skeleton skeleton-cell cost"></div>
                    <div class="skeleton skeleton-cell status"></div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    // API Helper
    async function fetchAPI(path) {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        throw new Error('No token');
      }

      const res = await fetch(`/backend${path}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (res.status === 401) {
        localStorage.removeItem('token');
        window.location.href = '/login.html';
        throw new Error('Unauthorized');
      }

      if (!res.ok) {
        throw new Error(`API Error: ${res.status}`);
      }

      return res.json();
    }

    // Logout
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    }

    // Show error
    function showError(message) {
      const banner = document.getElementById('errorBanner');
      banner.textContent = message;
      banner.style.display = 'block';
    }

    // Hide error
    function hideError() {
      document.getElementById('errorBanner').style.display = 'none';
    }

    // Format time
    function formatTime(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleTimeString('zh-CN', { hour12: false });
    }

    // Format cost
    function formatCost(cost) {
      if (cost === null || cost === undefined || cost === 0) return '-';
      return cost.toFixed(4);
    }

    // Render stats
    function renderStats(data) {
      const { antigravity, kiro, qwen, codex, antigravityConsumption, kiroStats, qwenStats, codexStats } = data;

      // Calculate totals
      const totalAccounts =
        (antigravity?.length || 0) +
        (kiro?.length || 0) +
        (qwen?.length || 0) +
        (codex?.length || 0);

      const activeAntigravity = antigravity?.filter(a => a.is_active !== false)?.length || 0;
      const activeKiro = kiro?.filter(a => a.is_active !== false)?.length || 0;
      const activeQwen = qwen?.filter(a => a.is_active !== false)?.length || 0;
      const activeCodex = codex?.filter(a => a.is_active !== false)?.length || 0;
      const activeAccounts = activeAntigravity + activeKiro + activeQwen + activeCodex;

      // 24h consumption (from Antigravity quotas)
      const antigravityCost = antigravityConsumption?.total_cost || 0;

      // 24h calls
      const antigravityCalls = antigravityConsumption?.total_requests || 0;
      const kiroCalls = kiroStats?.total_requests || 0;
      const qwenCalls = qwenStats?.total_requests || 0;
      const codexCalls = codexStats?.total_requests || 0;
      const totalCalls = antigravityCalls + kiroCalls + qwenCalls + codexCalls;

      // Update stats cards
      document.getElementById('totalAccounts').textContent = totalAccounts;
      document.getElementById('totalAccounts').classList.remove('skeleton');

      document.getElementById('activeAccounts').textContent = activeAccounts;
      document.getElementById('activeAccounts').classList.remove('skeleton');

      document.getElementById('totalCost').textContent = antigravityCost.toFixed(2);
      document.getElementById('totalCost').classList.remove('skeleton');

      document.getElementById('totalCalls').textContent = totalCalls;
      document.getElementById('totalCalls').classList.remove('skeleton');

      // Update channel cards
      // Antigravity
      document.getElementById('antigravityStat1').innerHTML =
        `<span>${activeAntigravity}</span>/${antigravity?.length || 0} 活跃`;
      document.getElementById('antigravityStat1').classList.remove('skeleton');
      document.getElementById('antigravityStat2').textContent =
        `24h: ${antigravityCalls} 次`;
      document.getElementById('antigravityStat2').classList.remove('skeleton');

      // Kiro
      document.getElementById('kiroStat1').innerHTML =
        `<span>${activeKiro}</span>/${kiro?.length || 0} 活跃`;
      document.getElementById('kiroStat1').classList.remove('skeleton');
      document.getElementById('kiroStat2').textContent =
        `24h: ${kiroCalls} 次`;
      document.getElementById('kiroStat2').classList.remove('skeleton');

      // Qwen
      document.getElementById('qwenStat1').innerHTML =
        `<span>${activeQwen}</span>/${qwen?.length || 0} 活跃`;
      document.getElementById('qwenStat1').classList.remove('skeleton');
      document.getElementById('qwenStat2').textContent =
        `24h: ${qwenCalls} 次`;
      document.getElementById('qwenStat2').classList.remove('skeleton');

      // Codex
      document.getElementById('codexStat1').innerHTML =
        `<span>${activeCodex}</span>/${codex?.length || 0} 活跃`;
      document.getElementById('codexStat1').classList.remove('skeleton');
      document.getElementById('codexStat2').textContent =
        `24h: ${codexCalls} 次`;
      document.getElementById('codexStat2').classList.remove('skeleton');
    }

    // Render recent calls
    function renderRecentCalls(data) {
      const { antigravityConsumption, kiroStats, qwenStats, codexStats } = data;

      // Collect all recent calls
      const calls = [];

      // Antigravity calls (from consumption details)
      if (antigravityConsumption?.details) {
        antigravityConsumption.details.forEach(d => {
          calls.push({
            time: d.timestamp || d.created_at,
            channel: 'Antigravity',
            model: d.model || '-',
            cost: d.cost,
            success: true
          });
        });
      }

      // Kiro calls
      if (kiroStats?.recent_requests) {
        kiroStats.recent_requests.forEach(r => {
          calls.push({
            time: r.created_at,
            channel: 'Kiro',
            model: r.model || '-',
            cost: null,
            success: r.success !== false
          });
        });
      }

      // Qwen calls
      if (qwenStats?.recent_requests) {
        qwenStats.recent_requests.forEach(r => {
          calls.push({
            time: r.created_at,
            channel: 'Qwen',
            model: r.model || '-',
            cost: null,
            success: r.success !== false
          });
        });
      }

      // Codex calls
      if (codexStats?.recent_requests) {
        codexStats.recent_requests.forEach(r => {
          calls.push({
            time: r.created_at,
            channel: 'Codex',
            model: r.model || '-',
            cost: null,
            success: r.success !== false
          });
        });
      }

      // Sort by time descending
      calls.sort((a, b) => new Date(b.time) - new Date(a.time));

      // Take top 30
      const recentCalls = calls.slice(0, 30);

      // Render table
      const tbody = document.getElementById('recentCalls');

      if (recentCalls.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="empty-state">暂无调用记录</td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = recentCalls.map(call => `
        <tr>
          <td>${formatTime(call.time)}</td>
          <td>${call.channel}</td>
          <td>${call.model}</td>
          <td>${formatCost(call.cost)}</td>
          <td class="${call.success ? 'status-success' : 'status-error'}">
            ${call.success ? '✓' : '✗'}
          </td>
        </tr>
      `).join('');
    }

    // Load dashboard data
    async function loadDashboard() {
      const refreshBtn = document.getElementById('refreshBtn');
      refreshBtn.disabled = true;
      hideError();

      try {
        // Parallel fetch all data
        const [antigravity, kiro, qwen, codex, antigravityConsumption, kiroStats, qwenStats, codexStats] =
          await Promise.all([
            fetchAPI('/api/accounts').catch(() => []),
            fetchAPI('/api/kiro/accounts').catch(() => []),
            fetchAPI('/api/qwen/accounts').catch(() => []),
            fetchAPI('/api/codex/accounts').catch(() => []),
            fetchAPI('/api/quotas/consumption').catch(() => ({})),
            fetchAPI('/api/kiro/consumption/stats').catch(() => ({})),
            fetchAPI('/api/request-usage/stats?config_type=qwen').catch(() => ({})),
            fetchAPI('/api/request-usage/stats?config_type=codex').catch(() => ({})),
          ]);

        const data = {
          antigravity,
          kiro,
          qwen,
          codex,
          antigravityConsumption,
          kiroStats,
          qwenStats,
          codexStats
        };

        renderStats(data);
        renderRecentCalls(data);

      } catch (err) {
        console.error('Dashboard load error:', err);
        showError('加载数据失败: ' + err.message);
      } finally {
        refreshBtn.disabled = false;
      }
    }

    // Check auth and load
    function init() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      loadDashboard();
    }

    // Start
    init();
  </script>
</body>
</html>
